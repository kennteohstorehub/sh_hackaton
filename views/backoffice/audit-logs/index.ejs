<div class="storehub-container">
  <!-- Header -->
  <div class="storehub-page-header">
    <div class="header-content">
      <h1 class="storehub-page-title"><%= contentTitle %></h1>
      <p class="storehub-page-subtitle"><%= contentSubtitle %></p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="exportAuditLogs()">
        <span class="btn-icon">üì•</span>
        Export CSV
      </button>
      <button class="btn btn-primary" onclick="refreshStats()">
        <span class="btn-icon">üîÑ</span>
        Refresh
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <span class="card-icon">üîç</span>
        Filter Audit Logs
      </h3>
    </div>
    <div class="card-body">
      <form method="GET" class="storehub-form">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Search</label>
            <input type="text" 
                   class="form-control" 
                   name="search" 
                   value="<%= filters.search %>" 
                   placeholder="Action, entity, or user...">
          </div>
          <div class="form-group">
            <label class="form-label">Action</label>
            <select class="form-control" name="action">
              <option value="all" <%= filters.action === 'all' ? 'selected' : '' %>>All Actions</option>
              <% if (typeof filterOptions !== 'undefined' && filterOptions.actions) { %>
                <% filterOptions.actions.forEach(action => { %>
                  <option value="<%= action %>" <%= filters.action === action ? 'selected' : '' %>>
                    <%= action %>
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Entity</label>
            <select class="form-control" name="entity">
              <option value="all" <%= filters.entity === 'all' ? 'selected' : '' %>>All Entities</option>
              <% if (typeof filterOptions !== 'undefined' && filterOptions.entities) { %>
                <% filterOptions.entities.forEach(entity => { %>
                  <option value="<%= entity %>" <%= filters.entity === entity ? 'selected' : '' %>>
                    <%= entity %>
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">User</label>
            <select class="form-control" name="user">
              <option value="all" <%= filters.user === 'all' ? 'selected' : '' %>>All Users</option>
              <% if (typeof filterOptions !== 'undefined' && filterOptions.users) { %>
                <% filterOptions.users.forEach(user => { %>
                  <option value="<%= user.id %>" <%= filters.user === user.id ? 'selected' : '' %>>
                    <%= user.name || user.email %>
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Date From</label>
            <input type="date" 
                   class="form-control" 
                   name="dateFrom" 
                   value="<%= filters.dateFrom %>">
          </div>
          <div class="form-group form-actions">
            <button type="submit" class="btn btn-primary">
              <span class="btn-icon">üîç</span>
              Search
            </button>
            <a href="/backoffice/audit-logs" class="btn btn-secondary">
              <span class="btn-icon">‚ùå</span>
              Clear
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stats-card">
      <div class="stats-icon">üìã</div>
      <div class="stats-value" id="totalLogs"><%= typeof auditLogs !== 'undefined' ? auditLogs.length : 0 %></div>
      <div class="stats-label">Total Logs</div>
      <div class="stats-trend trend-positive">
        <span>‚Üë Active monitoring</span>
      </div>
    </div>
    <div class="stats-card">
      <div class="stats-icon">üìä</div>
      <div class="stats-value" id="topAction">-</div>
      <div class="stats-label">Top Action</div>
      <div class="stats-trend trend-positive">
        <span>üî• Most frequent</span>
      </div>
    </div>
    <div class="stats-card">
      <div class="stats-icon">üóú</div>
      <div class="stats-value" id="topEntity">-</div>
      <div class="stats-label">Top Entity</div>
      <div class="stats-trend trend-neutral">
        <span>üéØ Most accessed</span>
      </div>
    </div>
    <div class="stats-card">
      <div class="stats-icon">üë§</div>
      <div class="stats-value" id="topUser">-</div>
      <div class="stats-label">Most Active User</div>
      <div class="stats-trend trend-positive">
        <span>üëë Top contributor</span>
      </div>
    </div>
  </div>

  <!-- Audit Logs Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <span class="card-icon">üóí</span>
        Audit Log Entries
      </h3>
      <div class="card-actions">
        <span class="badge badge-info">
          <span id="tableCount"><%= typeof auditLogs !== 'undefined' ? auditLogs.length : 0 %></span> entries
        </span>
      </div>
    </div>
    <div class="card-body" style="padding: 0;">
      <% if (typeof auditLogs === 'undefined' || auditLogs.length === 0) { %>
        <div class="empty-state">
          <div class="empty-state-icon">üîç</div>
          <p>No audit logs found</p>
          <% if (filters.search || filters.action !== 'all' || filters.entity !== 'all' || filters.user !== 'all' || filters.dateFrom) { %>
            <p>Try adjusting your filters to see more results</p>
            <a href="/backoffice/audit-logs" class="btn btn-primary">
              Clear Filters
            </a>
          <% } else { %>
            <p>No audit logs are available at this time</p>
          <% } %>
        </div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Action</th>
                <th>Entity</th>
                <th>User</th>
                <th>IP Address</th>
                <th>Details</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% auditLogs.forEach(log => { %>
                <tr>
                  <td>
                    <div class="timestamp-wrapper">
                      <div class="fw-bold"><%= new Date(log.timestamp || log.createdAt).toLocaleDateString() %></div>
                      <small class="text-muted"><%= new Date(log.timestamp || log.createdAt).toLocaleTimeString() %></small>
                    </div>
                  </td>
                  <td>
                    <span class="badge <%= 
                      log.action.includes('create') ? 'badge-success' :
                      log.action.includes('update') ? 'badge-warning' :
                      log.action.includes('delete') ? 'badge-danger' :
                      log.action.includes('login') ? 'badge-info' : 'badge-secondary'
                    %>">
                      <%= log.action %>
                    </span>
                  </td>
                  <td>
                    <div class="entity-info">
                      <div class="fw-bold"><%= log.resourceType || log.resource || '-' %></div>
                      <% if (log.resourceId) { %>
                        <small class="text-muted">
                          ID: <%= log.resourceId %>
                        </small>
                      <% } %>
                    </div>
                  </td>
                  <td>
                    <% if (log.backOfficeUserId || log.userId) { %>
                      <div class="user-info">
                        <span>üë§</span>
                        <span class="fw-medium"><%= log.backOfficeUserId || log.userId %></span>
                      </div>
                    <% } else { %>
                      <div class="system-info">
                        <span>ü§ñ</span>
                        <span class="text-muted">System</span>
                      </div>
                    <% } %>
                  </td>
                  <td>
                    <small class="text-muted"><%= log.ipAddress || 'N/A' %></small>
                  </td>
                  <td>
                    <% if (log.details && typeof log.details === 'object') { %>
                      <span class="badge badge-info">
                        <% if (log.details.changes) { %>
                          <%= Object.keys(log.details.changes).length %> changes
                        <% } else { %>
                          <%= Object.keys(log.details).length %> details
                        <% } %>
                      </span>
                    <% } else { %>
                      <small class="text-muted">-</small>
                    <% } %>
                  </td>
                  <td>
                    <a href="/backoffice/audit-logs/<%= log.id %>" class="btn btn-sm btn-text">
                      View
                    </a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Pagination -->
  <% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { %>
    <div class="pagination-wrapper">
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <% if (pagination.currentPage > 1) { %>
            <li class="page-item">
              <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>&<%= new URLSearchParams(filters).toString() %>">
                Previous
              </a>
            </li>
          <% } %>
          
          <% for (let i = 1; i <= pagination.totalPages; i++) { %>
            <% if (i <= 3 || i > pagination.totalPages - 3 || (i >= pagination.currentPage - 1 && i <= pagination.currentPage + 1)) { %>
              <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&<%= new URLSearchParams(filters).toString() %>">
                  <%= i %>
                </a>
              </li>
            <% } else if ((i === 4 && pagination.currentPage > 5) || (i === pagination.totalPages - 3 && pagination.currentPage < pagination.totalPages - 4)) { %>
              <li class="page-item disabled">
                <span class="page-link">...</span>
              </li>
            <% } %>
          <% } %>
          
          <% if (pagination.currentPage < pagination.totalPages) { %>
            <li class="page-item">
              <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>&<%= new URLSearchParams(filters).toString() %>">
                Next
              </a>
            </li>
          <% } %>
        </ul>
      </nav>
    </div>
  <% } %>
</div>

<script>
// Calculate stats on page load
document.addEventListener('DOMContentLoaded', function() {
  calculateStats();
});

function calculateStats() {
  <% if (typeof auditLogs !== 'undefined' && auditLogs.length > 0) { %>
    // Calculate top action
    const actions = {};
    <% auditLogs.forEach(log => { %>
      actions['<%= log.action %>'] = (actions['<%= log.action %>'] || 0) + 1;
    <% }) %>
    const topAction = Object.keys(actions).reduce((a, b) => actions[a] > actions[b] ? a : b);
    document.getElementById('topAction').textContent = topAction;

    // Calculate top entity
    const entities = {};
    <% auditLogs.forEach(log => { %>
      <% if (log.resourceType || log.resource) { %>
        entities['<%= log.resourceType || log.resource %>'] = (entities['<%= log.resourceType || log.resource %>'] || 0) + 1;
      <% } %>
    <% }) %>
    if (Object.keys(entities).length > 0) {
      const topEntity = Object.keys(entities).reduce((a, b) => entities[a] > entities[b] ? a : b);
      document.getElementById('topEntity').textContent = topEntity;
    }

    // Calculate most active user
    const users = {};
    <% auditLogs.forEach(log => { %>
      <% if (log.backOfficeUserId || log.userId) { %>
        users['<%= log.backOfficeUserId || log.userId %>'] = (users['<%= log.backOfficeUserId || log.userId %>'] || 0) + 1;
      <% } %>
    <% }) %>
    if (Object.keys(users).length > 0) {
      const topUser = Object.keys(users).reduce((a, b) => users[a] > users[b] ? a : b);
      document.getElementById('topUser').textContent = topUser.length > 20 ? topUser.substring(0, 20) + '...' : topUser;
    }
  <% } %>
}

function exportAuditLogs() {
  const params = new URLSearchParams(window.location.search);
  params.set('export', 'csv');
  window.location.href = '/backoffice/audit-logs?' + params.toString();
}

function refreshStats() {
  window.location.reload();
}
</script>