<%- include('../layout', { title: title }) %>

<div class="container-fluid mt-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/backoffice/audit-logs">Audit Logs</a></li>
              <li class="breadcrumb-item active">Log Details</li>
            </ol>
          </nav>
          <h2 class="mb-1"><%= contentTitle %></h2>
          <p class="text-muted mb-0"><%= contentSubtitle %></p>
        </div>
        <div>
          <a href="/backoffice/audit-logs" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Logs
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Main Details -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Log Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td class="fw-medium">Action:</td>
                  <td>
                    <span class="badge bg-<%= 
                      auditLog.action.includes('create') ? 'success' :
                      auditLog.action.includes('update') ? 'warning' :
                      auditLog.action.includes('delete') ? 'danger' :
                      auditLog.action.includes('login') ? 'info' : 'secondary'
                    %> fs-6">
                      <%= auditLog.action %>
                    </span>
                  </td>
                </tr>
                <tr>
                  <td class="fw-medium">Resource Type:</td>
                  <td><%= auditLog.resource %></td>
                </tr>
                <tr>
                  <td class="fw-medium">Resource ID:</td>
                  <td>
                    <% if (auditLog.resourceId) { %>
                      <code><%= auditLog.resourceId %></code>
                    <% } else { %>
                      <span class="text-muted">N/A</span>
                    <% } %>
                  </td>
                </tr>
                <tr>
                  <td class="fw-medium">Timestamp:</td>
                  <td>
                    <div><%= new Date(auditLog.createdAt).toLocaleString() %></div>
                    <small class="text-muted">
                      (<%= Math.floor((new Date() - new Date(auditLog.createdAt)) / 1000 / 60) %> minutes ago)
                    </small>
                  </td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td class="fw-medium">User:</td>
                  <td>
                    <% if (auditLog.userId) { %>
                      <div>
                        <div class="text-muted"><%= auditLog.userId %></div>
                        <span class="badge bg-<%= auditLog.userType === 'SUPERADMIN' ? 'primary' : 'secondary' %>">
                          <%= auditLog.userType %>
                        </span>
                      </div>
                    <% } else { %>
                      <span class="text-muted">System</span>
                    <% } %>
                  </td>
                </tr>
                <tr>
                  <td class="fw-medium">IP Address:</td>
                  <td>
                    <% if (auditLog.ipAddress) { %>
                      <code><%= auditLog.ipAddress %></code>
                    <% } else { %>
                      <span class="text-muted">N/A</span>
                    <% } %>
                  </td>
                </tr>
                <tr>
                  <td class="fw-medium">User Agent:</td>
                  <td>
                    <% if (auditLog.userAgent) { %>
                      <small class="text-muted" title="<%= auditLog.userAgent %>">
                        <%= auditLog.userAgent.length > 50 ? auditLog.userAgent.substring(0, 50) + '...' : auditLog.userAgent %>
                      </small>
                    <% } else { %>
                      <span class="text-muted">N/A</span>
                    <% } %>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Details/Changes -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-edit me-2"></i>Details & Changes
          </h5>
        </div>
        <div class="card-body">
          <% if (auditLog.details && typeof auditLog.details === 'object') { %>
            <% if (auditLog.details.changes && Object.keys(auditLog.details.changes).length > 0) { %>
              <h6 class="mb-3">Field Changes:</h6>
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Field</th>
                      <th>Before</th>
                      <th>After</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% Object.entries(auditLog.details.changes).forEach(([field, change]) => { %>
                      <tr>
                        <td class="fw-medium"><%= field %></td>
                        <td>
                          <% if (change.from !== undefined && change.from !== null) { %>
                            <% if (typeof change.from === 'object') { %>
                              <code><%= JSON.stringify(change.from, null, 2) %></code>
                            <% } else { %>
                              <code><%= change.from %></code>
                            <% } %>
                          <% } else { %>
                            <span class="text-muted">null</span>
                          <% } %>
                        </td>
                        <td>
                          <% if (change.to !== undefined && change.to !== null) { %>
                            <% if (typeof change.to === 'object') { %>
                              <code><%= JSON.stringify(change.to, null, 2) %></code>
                            <% } else { %>
                              <code><%= change.to %></code>
                            <% } %>
                          <% } else { %>
                            <span class="text-muted">null</span>
                          <% } %>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } %>

            <% if (auditLog.details.metadata && Object.keys(auditLog.details.metadata).length > 0) { %>
              <h6 class="mb-3 <%= auditLog.details.changes ? 'mt-4' : '' %>">Metadata:</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <tbody>
                    <% Object.entries(auditLog.details.metadata).forEach(([key, value]) => { %>
                      <tr>
                        <td class="fw-medium" style="width: 200px;"><%= key %>:</td>
                        <td>
                          <% if (typeof value === 'object') { %>
                            <pre class="mb-0"><%= JSON.stringify(value, null, 2) %></pre>
                          <% } else { %>
                            <%= value %>
                          <% } %>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } %>

            <% if (!auditLog.details.changes && !auditLog.details.metadata) { %>
              <h6 class="mb-3">Raw Details:</h6>
              <pre class="bg-light p-3 rounded"><%= JSON.stringify(auditLog.details, null, 2) %></pre>
            <% } %>
          <% } else if (auditLog.details) { %>
            <h6 class="mb-3">Details:</h6>
            <div class="alert alert-info">
              <%= auditLog.details %>
            </div>
          <% } else { %>
            <div class="text-center py-4">
              <i class="fas fa-info-circle text-muted fa-2x mb-3"></i>
              <p class="text-muted">No additional details available for this log entry</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
      <!-- Quick Info -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-tachometer-alt me-2"></i>Quick Info
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-12 mb-3">
              <h3 class="text-primary mb-1">
                <i class="fas fa-<%= 
                  auditLog.action.includes('create') ? 'plus-circle text-success' :
                  auditLog.action.includes('update') ? 'edit text-warning' :
                  auditLog.action.includes('delete') ? 'trash text-danger' :
                  auditLog.action.includes('login') ? 'sign-in-alt text-info' : 'cog'
                %>"></i>
              </h3>
              <div class="fw-medium"><%= auditLog.action %></div>
              <small class="text-muted">Action Type</small>
            </div>
            <div class="col-6">
              <div class="border-end">
                <div class="fw-medium"><%= auditLog.resource %></div>
                <small class="text-muted">Resource</small>
              </div>
            </div>
            <div class="col-6">
              <div class="fw-medium">
                <% if (auditLog.userId) { %>
                  <%= auditLog.userId.split('-')[0] %>
                <% } else { %>
                  System
                <% } %>
              </div>
              <small class="text-muted">User</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Related Actions -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-link me-2"></i>Related Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <% if (auditLog.resource === 'tenant' && auditLog.resourceId) { %>
              <a href="/backoffice/tenants/<%= auditLog.resourceId %>" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-building me-2"></i>View Tenant
              </a>
            <% } %>
            <% if (auditLog.resource === 'merchant' && auditLog.resourceId) { %>
              <a href="/backoffice/merchants/<%= auditLog.resourceId %>" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-store me-2"></i>View Merchant
              </a>
            <% } %>
            <% if (auditLog.userId) { %>
              <a href="/backoffice/audit-logs?user=<%= auditLog.userId %>" class="btn btn-outline-info btn-sm">
                <i class="fas fa-user me-2"></i>User's Logs
              </a>
            <% } %>
            <a href="/backoffice/audit-logs?action=<%= auditLog.action %>" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-filter me-2"></i>Similar Actions
            </a>
            <a href="/backoffice/audit-logs?entity=<%= auditLog.resource %>" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-filter me-2"></i>Same Resource Type
            </a>
          </div>
        </div>
      </div>

      <!-- Technical Details -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-cogs me-2"></i>Technical Details
          </h5>
        </div>
        <div class="card-body">
          <table class="table table-sm table-borderless">
            <tr>
              <td class="fw-medium">Log ID:</td>
              <td><code><%= auditLog.id %></code></td>
            </tr>
            <% if (auditLog.resourceId) { %>
              <tr>
                <td class="fw-medium">Resource ID:</td>
                <td><code><%= auditLog.resourceId %></code></td>
              </tr>
            <% } %>
            <% if (auditLog.userId) { %>
              <tr>
                <td class="fw-medium">User ID:</td>
                <td><code><%= auditLog.userId %></code></td>
              </tr>
            <% } %>
            <tr>
              <td class="fw-medium">Created:</td>
              <td>
                <small class="text-muted">
                  <%= new Date(auditLog.createdAt).toISOString() %>
                </small>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
pre {
  font-size: 0.875rem;
  max-height: 300px;
  overflow-y: auto;
}

code {
  word-break: break-all;
}
</style>