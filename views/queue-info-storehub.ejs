<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= queueName %> - <%= businessName %></title>
    
    <!-- StoreHub Design System -->
    <link rel="stylesheet" href="/css/storehub-design-system.css?v=<%= Date.now() %>">
    <link rel="stylesheet" href="/css/storehub-queue-public.css?v=<%= Date.now() %>">
    <script src="/js/storehub-design-system.js?v=<%= Date.now() %>"></script>
    
    <!-- CSRF Token -->
    <meta name="csrf-token" content="<%= locals.csrfToken || '' %>">
    
    <style>
        /* Mobile-first responsive styles */
        body {
            background: var(--gray-100);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Mobile-first join form styles */
        .join-form-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 0;
            padding: var(--space-4);
            box-shadow: none;
        }
        
        @media (min-width: 768px) {
            .join-form-container {
                margin: var(--space-6) auto;
                border-radius: var(--radius-lg);
                padding: var(--space-6);
                box-shadow: var(--shadow-md);
            }
        }
        
        .storehub-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-4);
        }
        
        @media (min-width: 768px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Enhanced mobile form controls */
        .form-control {
            font-size: 16px !important; /* Prevents zoom on iOS */
            min-height: 48px; /* Better touch target */
            padding: var(--space-3) var(--space-4);
        }
        
        .btn {
            min-height: 56px; /* Larger touch target on mobile */
            font-size: 18px;
            font-weight: var(--weight-semibold);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .queue-header {
            background: white;
            border-bottom: 1px solid var(--gray-300);
            padding: var(--space-4) 0;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        @media (min-width: 768px) {
            .queue-header {
                padding: var(--space-6) 0;
                position: static;
            }
        }
        
        .queue-header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-4);
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .queue-header-content {
                padding: 0 var(--space-6);
            }
        }
        
        
        .queue-title {
            font-size: 24px;
            font-weight: var(--weight-bold);
            color: var(--gray-900);
            margin-bottom: var(--space-2);
            margin-top: 0;
        }
        
        @media (min-width: 768px) {
            .queue-title {
                font-size: var(--heading-1);
            }
        }
        
        .queue-subtitle {
            font-size: var(--body);
            color: var(--gray-600);
        }
        
        @media (min-width: 768px) {
            .queue-subtitle {
                font-size: var(--body-large);
            }
        }
        
        .main-content {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-4) var(--space-4);
            width: 100%;
        }
        
        @media (min-width: 768px) {
            .main-content {
                padding: var(--space-8) var(--space-6);
            }
        }
        
        .queue-stats-hero {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-4);
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .queue-stats-hero {
                padding: var(--space-8);
                box-shadow: var(--shadow-md);
                margin-bottom: var(--space-8);
            }
        }
        
        .big-number {
            font-size: 48px;
            font-weight: var(--weight-bold);
            color: var(--primary-orange);
            line-height: 1;
            margin-bottom: var(--space-2);
        }
        
        @media (min-width: 768px) {
            .big-number {
                font-size: 80px;
                margin-bottom: var(--space-3);
            }
        }
        
        .big-number-label {
            font-size: var(--body-large);
            color: var(--gray-700);
            margin-bottom: var(--space-4);
        }
        
        @media (min-width: 768px) {
            .big-number-label {
                font-size: var(--heading-3);
                margin-bottom: var(--space-6);
            }
        }
        
        .queue-stats-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-300);
        }
        
        @media (min-width: 480px) {
            .queue-stats-row {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--space-6);
                padding-top: var(--space-6);
            }
        }
        
        .queue-stat {
            text-align: center;
        }
        
        .queue-stat-value {
            font-size: var(--heading-2);
            font-weight: var(--weight-bold);
            color: var(--gray-900);
            display: block;
            margin-bottom: var(--space-2);
        }
        
        .queue-stat-label {
            font-size: var(--body);
            color: var(--gray-600);
        }
        
        .action-section {
            background: white;
            border-radius: 0;
            padding: var(--space-4);
            box-shadow: none;
            margin-bottom: var(--space-4);
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .action-section {
                border-radius: var(--radius-lg);
                padding: var(--space-6);
                box-shadow: var(--shadow-sm);
                margin-bottom: var(--space-6);
            }
        }
        
        .action-title {
            font-size: var(--heading-4);
            font-weight: var(--weight-semibold);
            color: var(--gray-900);
            margin-bottom: var(--space-3);
        }
        
        @media (min-width: 768px) {
            .action-title {
                font-size: var(--heading-3);
                margin-bottom: var(--space-4);
            }
        }
        
        .action-description {
            font-size: var(--body);
            color: var(--gray-600);
            margin-bottom: var(--space-4);
            padding: 0 var(--space-2);
        }
        
        @media (min-width: 768px) {
            .action-description {
                margin-bottom: var(--space-6);
                padding: 0;
            }
        }
        
        .join-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-3);
            margin-top: var(--space-4);
        }
        
        @media (min-width: 768px) {
            .join-methods {
                gap: var(--space-4);
                margin-top: var(--space-6);
            }
        }
        
        .join-method-card {
            background: var(--gray-100);
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            transition: all var(--transition-normal);
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            min-height: 64px;
        }
        
        @media (min-width: 768px) {
            .join-method-card {
                padding: var(--space-6);
                flex-direction: column;
                text-align: center;
                gap: 0;
                min-height: auto;
            }
        }
        
        .join-method-card:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: white;
        }
        
        .join-method-icon {
            width: 32px;
            height: 32px;
            color: var(--primary-orange);
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .join-method-icon {
                width: 48px;
                height: 48px;
                margin: 0 auto var(--space-3);
            }
        }
        
        .join-method-title {
            font-size: var(--body);
            font-weight: var(--weight-semibold);
            color: var(--gray-900);
            margin-bottom: 0;
        }
        
        @media (min-width: 768px) {
            .join-method-title {
                font-size: var(--body-large);
                margin-bottom: var(--space-2);
            }
        }
        
        .join-method-text {
            font-size: var(--small);
            color: var(--gray-600);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-3);
            margin-top: var(--space-6);
        }
        
        @media (min-width: 768px) {
            .info-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-4);
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
            }
        }
        
        @media (min-width: 1024px) {
            .info-grid {
                gap: var(--space-5);
            }
        }
        
        /* Mobile-optimized info cards */
        .storehub-info-card {
            padding: var(--space-5);
            background: white;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
            min-height: 80px;
        }
        
        @media (min-width: 768px) {
            .storehub-info-card {
                flex-direction: column;
                text-align: center;
                padding: var(--space-6) var(--space-4);
                min-height: 160px;
                justify-content: center;
            }
        }
        
        .storehub-info-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .storehub-info-icon {
            width: 40px;
            height: 40px;
            color: var(--primary-orange);
            flex-shrink: 0;
            padding: var(--space-2);
            background: var(--orange-50, rgba(250, 140, 22, 0.1));
            border-radius: var(--radius-full);
        }
        
        @media (min-width: 768px) {
            .storehub-info-icon {
                width: 48px;
                height: 48px;
                margin-bottom: var(--space-3);
            }
        }
        
        .storehub-info-content {
            flex: 1;
            min-width: 0; /* Prevents text overflow */
        }
        
        .storehub-info-title {
            font-size: var(--small);
            font-weight: var(--weight-medium);
            color: var(--gray-600);
            margin-bottom: var(--space-1);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        @media (min-width: 768px) {
            .storehub-info-title {
                font-size: var(--body-small);
            }
        }
        
        .storehub-info-text {
            font-size: var(--body);
            font-weight: var(--weight-medium);
            color: var(--gray-900);
            word-break: break-word;
            line-height: 1.4;
        }
        
        @media (min-width: 768px) {
            .storehub-info-text {
                font-size: var(--body-large);
            }
        }
        
        .queue-closed-banner {
            background: var(--error-red);
            color: white;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            text-align: center;
            font-weight: var(--weight-medium);
        }
        
        .refresh-indicator {
            position: fixed;
            bottom: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: var(--radius-full);
            padding: var(--space-2) var(--space-3);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--small);
            color: var(--gray-600);
            max-width: calc(100% - var(--space-8));
        }
        
        @media (min-width: 768px) {
            .refresh-indicator {
                bottom: var(--space-6);
                right: var(--space-6);
                left: auto;
                transform: none;
                padding: var(--space-3) var(--space-4);
                box-shadow: var(--shadow-lg);
                max-width: none;
            }
        }
        
        .refresh-dot {
            width: 8px;
            height: 8px;
            background: var(--success-green);
            border-radius: var(--radius-full);
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Success message styles */
        .success-container {
            text-align: center;
            padding: var(--space-5);
        }
        
        @media (min-width: 768px) {
            .success-container {
                padding: var(--space-8);
            }
        }
        
        .success-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto var(--space-4);
            background: var(--success-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .success-icon {
                width: 80px;
                height: 80px;
            }
        }
        
        .queue-number-display {
            font-size: var(--heading-2);
            color: var(--primary-orange);
            margin: var(--space-3) 0;
            font-weight: var(--weight-bold);
        }
        
        @media (min-width: 768px) {
            .queue-number-display {
                font-size: var(--heading-1);
                margin: var(--space-4) 0;
            }
        }
        
        /* Form label required indicator */
        .form-label.required::after {
            content: " *";
            color: var(--error-red);
        }
        
        /* Utility classes for responsive display */
        .d-none { display: none !important; }
        .d-md-none { display: none !important; }
        .d-md-inline { display: none !important; }
        
        @media (min-width: 768px) {
            .d-md-none { display: none !important; }
            .d-md-inline { display: inline !important; }
        }
    </style>
</head>
<body>
    <!-- Queue Header -->
    <div class="queue-header">
        <div class="queue-header-content">
            <h1 class="queue-title"><%= businessName %></h1>
            <p class="queue-subtitle">Live Queue Status</p>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <% if (!queueActive || !acceptingCustomers) { %>
        <div class="queue-closed-banner">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-right: 8px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            Queue is currently closed
        </div>
        <% } %>
        
        <!-- Queue Stats Hero -->
        <div class="queue-stats-hero">
            <div class="big-number" id="totalWaiting"><%= totalAhead %></div>
            <div class="big-number-label">People Currently Waiting</div>
            
            <div class="queue-stats-row">
                <div class="queue-stat">
                    <span class="queue-stat-value" id="avgWaitTime"><%= averageWaitTime %> min</span>
                    <span class="queue-stat-label">Average Wait Time</span>
                </div>
                <div class="queue-stat">
                    <span class="queue-stat-value" id="queueStatus">
                        <% if (queueActive && acceptingCustomers) { %>
                            <span style="color: var(--success-green);">Open</span>
                        <% } else { %>
                            <span style="color: var(--error-red);">Closed</span>
                        <% } %>
                    </span>
                    <span class="queue-stat-label">Queue Status</span>
                </div>
                <div class="queue-stat">
                    <span class="queue-stat-value"><%= businessHours %></span>
                    <span class="queue-stat-label">Business Hours</span>
                </div>
            </div>
        </div>
        
        <% if (queueActive && acceptingCustomers) { %>
        <!-- Join Queue Section -->
        <div class="action-section">
            <h2 class="action-title">Join Our Queue</h2>
            <p class="action-description">Skip the physical line and wait comfortably. We'll notify you when it's your turn!</p>
            
            <!-- Join Queue Form -->
            <div class="join-form-container">
                <form id="joinQueueForm" class="storehub-form">
                    <div class="form-group">
                        <label class="form-label required">Your Name</label>
                        <input type="text" 
                               class="form-control" 
                               id="customerName" 
                               name="customerName" 
                               required 
                               placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Phone Number</label>
                            <input type="tel" 
                                   class="form-control" 
                                   id="customerPhone" 
                                   name="customerPhone" 
                                   required 
                                   placeholder="+60123456789">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required">Party Size</label>
                            <select class="form-control" id="partySize" name="partySize" required>
                                <option value="">Select size</option>
                                <% 
                                // Use merchant's max party size setting, default to 5
                                const maxPartySize = locals.merchantSettings?.partySizeRegularMax || 5;
                                for (let i = 1; i <= maxPartySize; i++) { 
                                %>
                                    <option value="<%= i %>"><%= i %> <%= i === 1 ? 'person' : 'people' %></option>
                                <% } %>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Special Requests</label>
                        <textarea class="form-control" 
                                  id="specialRequests" 
                                  name="specialRequests" 
                                  rows="3" 
                                  placeholder="Any special requirements or requests? (optional)"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg btn-block" id="submitBtn">
                        Join Queue Now
                    </button>
                </form>
            </div>
            
            <div class="join-methods">
                <a href="tel:<%= businessPhone %>" class="join-method-card">
                    <svg class="join-method-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <div class="join-method-title">Call Us</div>
                    <div class="join-method-text"><%= businessPhone %></div>
                </a>
            </div>
        </div>
        <% } %>
        
        <!-- Business Info -->
        <div class="info-grid">
            <div class="storehub-info-card">
                <svg class="storehub-info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div class="storehub-info-content">
                    <h4 class="storehub-info-title">Location</h4>
                    <p class="storehub-info-text"><%= businessAddress %></p>
                </div>
            </div>
            
            <div class="storehub-info-card">
                <svg class="storehub-info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <div class="storehub-info-content">
                    <h4 class="storehub-info-title">Contact</h4>
                    <p class="storehub-info-text"><%= businessEmail %></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Refresh Indicator -->
    <div class="refresh-indicator">
        <div class="refresh-dot"></div>
        <span class="d-none d-md-inline">Live updates every 30 seconds</span>
        <span class="d-md-none">Live updates</span>
    </div>
    
    
    <script>
        // Form submission handler
        document.getElementById('joinQueueForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner" style="width: 20px; height: 20px; margin-right: 8px;"></span> Joining queue...';
            
            const formData = {
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                partySize: parseInt(document.getElementById('partySize').value),
                specialRequests: document.getElementById('specialRequests').value || null,
                merchantId: '<%= merchantId %>',
                pushSubscription: null // Can be added later for push notifications
            };
            
            try {
                const response = await fetch('/api/queues/join', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Store queue entry info for status page
                    sessionStorage.setItem('queueEntryId', data.queueEntry.id);
                    sessionStorage.setItem('queueNumber', data.queueNumber);
                    sessionStorage.setItem('verificationCode', data.verificationCode);
                    
                    // Show success message
                    const successHtml = `
                        <div class="success-container">
                            <div class="success-icon">
                                <svg width="40" height="40" fill="none" stroke="var(--success-green)" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <h2 style="font-size: var(--heading-3); margin-bottom: var(--space-2);">You're in the Queue!</h2>
                            <div class="queue-number-display">
                                #${data.queueNumber}
                            </div>
                            <p style="color: var(--gray-600); margin-bottom: var(--space-3);">
                                Estimated wait time: <strong>${data.estimatedWaitTime || 15} minutes</strong>
                            </p>
                            <p style="color: var(--gray-600); margin-bottom: var(--space-5);">
                                We'll notify you via SMS when it's almost your turn.
                            </p>
                            <a href="/queue-status/<%= queueId %>/${data.queueEntry.id}" class="btn btn-primary btn-block">
                                View Queue Status
                            </a>
                        </div>
                    `;
                    
                    // Replace form with success message
                    document.querySelector('.join-form-container').innerHTML = successHtml;
                    
                    // Scroll to success message
                    document.querySelector('.success-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                } else {
                    if (typeof StoreHubDS !== 'undefined') {
                        StoreHubDS.showToast(data.error || 'Failed to join queue', 'error');
                    } else {
                        alert(data.error || 'Failed to join queue');
                    }
                }
            } catch (error) {
                console.error('Error joining queue:', error);
                if (typeof StoreHubDS !== 'undefined') {
                    StoreHubDS.showToast('Network error. Please try again.', 'error');
                } else {
                    alert('Network error. Please try again.');
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // Format phone number as user types
        document.getElementById('customerPhone')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('60')) {
                // Malaysian number
                if (value.length > 2) {
                    value = '+60' + value.substring(2);
                }
            } else if (!value.startsWith('+')) {
                value = '+60' + value;
            }
            e.target.value = value;
        });
        
        
        // Auto-refresh stats every 30 seconds
        async function refreshStats() {
            try {
                const response = await fetch('/api/queue/<%= queueId %>/stats');
                const stats = await response.json();
                
                // Update displayed values
                document.getElementById('totalWaiting').textContent = stats.waitingCount || 0;
                document.getElementById('avgWaitTime').textContent = (stats.averageWaitTime || 15) + ' min';
                
                // Update queue status
                const statusElement = document.getElementById('queueStatus');
                if (stats.isActive && stats.acceptingCustomers) {
                    statusElement.innerHTML = '<span style="color: var(--success-green);">Open</span>';
                } else {
                    statusElement.innerHTML = '<span style="color: var(--error-red);">Closed</span>';
                }
                
                // Update last updated time
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Failed to refresh stats:', error);
            }
        }
        
        // Set up auto-refresh
        setInterval(refreshStats, 30000);
        
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    </script>
</body>
</html>