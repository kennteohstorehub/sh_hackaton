<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Connection - Smart Queue Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: rgb(255, 140, 0);
            --primary-hover: rgb(230, 126, 0);
        }
        
        .navbar-brand, .btn-primary, .badge-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover) !important;
            border-color: var(--primary-hover) !important;
        }
        
        .qr-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 2rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-connected { background-color: #28a745; }
        .status-waiting { background-color: #ffc107; }
        .status-disconnected { background-color: #dc3545; }
        
        .qr-code-display {
            text-align: center;
            padding: 2rem;
        }
        
        .connection-steps {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .step-number {
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--primary-color);">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-users me-2"></i>Smart Queue Manager
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fab fa-whatsapp me-2"></i>WhatsApp Connection
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Connection Status -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Connection Status</h6>
                                        <div id="connection-status">
                                            <span class="status-indicator status-disconnected"></span>
                                            <span id="status-text">Initializing...</span>
                                        </div>
                                        <small class="text-muted d-block mt-2" id="status-message">
                                            Setting up WhatsApp connection...
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Actions</h6>
                                        <button class="btn btn-primary btn-sm me-2" onclick="refreshStatus()">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="disconnect()" id="disconnect-btn" disabled>
                                            <i class="fas fa-sign-out-alt me-1"></i>Disconnect
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- QR Code Section -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="qr-container" id="qr-container">
                                    <div class="qr-code-display" id="qr-display">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-3 mb-0">Generating QR Code...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="connection-steps">
                                    <h6 class="mb-3">How to Connect:</h6>
                                    <div class="step">
                                        <div class="step-number">1</div>
                                        <div>Open WhatsApp on your phone</div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">2</div>
                                        <div>Go to Settings â†’ Linked Devices</div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">3</div>
                                        <div>Tap "Link a Device"</div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">4</div>
                                        <div>Scan the QR code displayed here</div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">5</div>
                                        <div>Wait for connection confirmation</div>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Note:</strong> You can use your existing WhatsApp number. 
                                        This will link your account just like WhatsApp Web.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Messages (when connected) -->
                        <div class="row mt-4" id="messages-section" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Recent Messages</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="recent-messages">
                                            <p class="text-muted">No recent messages</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let isConnected = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            setupSocketListeners();
        });

        function setupSocketListeners() {
            // WhatsApp QR code received
            socket.on('whatsapp-qr', function(data) {
                displayQRCode(data.qr);
                updateStatus('waiting_for_scan', 'Waiting for QR scan', 'Please scan the QR code with your phone');
            });

            // WhatsApp ready
            socket.on('whatsapp-ready', function(data) {
                isConnected = true;
                updateStatus('connected', 'Connected', 'WhatsApp is connected and ready');
                hideQRCode();
                showMessagesSection();
                document.getElementById('disconnect-btn').disabled = false;
            });

            // WhatsApp disconnected
            socket.on('whatsapp-disconnected', function(data) {
                isConnected = false;
                updateStatus('disconnected', 'Disconnected', `Connection lost: ${data.reason}`);
                showQRCode();
                hideMessagesSection();
                document.getElementById('disconnect-btn').disabled = true;
            });

            // Message received
            socket.on('whatsapp-message-received', function(data) {
                addMessageToList(data);
            });
        }

        async function refreshStatus() {
            try {
                const response = await fetch('/api/whatsapp/status');
                const status = await response.json();
                
                if (status.isConnected) {
                    isConnected = true;
                    updateStatus('connected', 'Connected', 'WhatsApp is connected and ready');
                    hideQRCode();
                    showMessagesSection();
                    document.getElementById('disconnect-btn').disabled = false;
                } else {
                    // Try to get QR code
                    const qrResponse = await fetch('/api/whatsapp/qr');
                    const qrData = await qrResponse.json();
                    
                    if (qrData.qr) {
                        displayQRCode(qrData.qr);
                        updateStatus('waiting_for_scan', 'Waiting for QR scan', qrData.message);
                    } else {
                        updateStatus('disconnected', 'Initializing', qrData.message);
                    }
                }
            } catch (error) {
                console.error('Error refreshing status:', error);
                updateStatus('disconnected', 'Error', 'Failed to get connection status');
            }
        }

        function updateStatus(status, text, message) {
            const indicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('status-text');
            const statusMessage = document.getElementById('status-message');
            
            // Update indicator color
            indicator.className = 'status-indicator';
            if (status === 'connected') {
                indicator.classList.add('status-connected');
            } else if (status === 'waiting_for_scan') {
                indicator.classList.add('status-waiting');
            } else {
                indicator.classList.add('status-disconnected');
            }
            
            statusText.textContent = text;
            statusMessage.textContent = message;
        }

        function displayQRCode(qrString) {
            const qrDisplay = document.getElementById('qr-display');
            qrDisplay.innerHTML = `
                <div id="qrcode"></div>
                <p class="mt-3 mb-0">Scan this QR code with WhatsApp</p>
            `;
            
            // Generate QR code using a simple library or display as text
            // For now, we'll show instructions to check the terminal
            document.getElementById('qrcode').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-terminal me-2"></i>
                    <strong>QR Code Generated!</strong><br>
                    Please check your terminal/console to see the QR code, or use your phone to scan it directly from the terminal.
                </div>
            `;
        }

        function hideQRCode() {
            const qrDisplay = document.getElementById('qr-display');
            qrDisplay.innerHTML = `
                <div class="text-success">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h5>Connected Successfully!</h5>
                    <p class="mb-0">WhatsApp is now connected and ready to send messages.</p>
                </div>
            `;
        }

        function showQRCode() {
            refreshStatus();
        }

        function showMessagesSection() {
            document.getElementById('messages-section').style.display = 'block';
        }

        function hideMessagesSection() {
            document.getElementById('messages-section').style.display = 'none';
        }

        function addMessageToList(messageData) {
            const messagesContainer = document.getElementById('recent-messages');
            const messageTime = new Date(messageData.timestamp * 1000).toLocaleTimeString();
            
            const messageHtml = `
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>${messageData.name || messageData.from}</strong>
                        <small class="text-muted">${messageTime}</small>
                    </div>
                    <div class="text-muted small">${messageData.from}</div>
                    <div class="mt-1">${messageData.message}</div>
                </div>
            `;
            
            if (messagesContainer.innerHTML.includes('No recent messages')) {
                messagesContainer.innerHTML = messageHtml;
            } else {
                messagesContainer.insertAdjacentHTML('afterbegin', messageHtml);
            }
            
            // Keep only last 10 messages
            const messages = messagesContainer.children;
            if (messages.length > 10) {
                messagesContainer.removeChild(messages[messages.length - 1]);
            }
        }

        async function disconnect() {
            if (confirm('Are you sure you want to disconnect WhatsApp?')) {
                try {
                    await fetch('/api/whatsapp/disconnect', { method: 'POST' });
                    updateStatus('disconnected', 'Disconnecting...', 'Disconnecting from WhatsApp...');
                } catch (error) {
                    console.error('Error disconnecting:', error);
                }
            }
        }

        // Auto-refresh status every 30 seconds
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html> 